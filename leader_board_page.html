<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
      <!-- External CSS -->
    <link rel="stylesheet" href = "styling.css">
      <!--BookStrap Link-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat&family=Oswald:wght@200;300&family=Playpen+Sans:wght@500&family=Poppins&family=Ubuntu:wght@500&display=swap" rel="stylesheet">
      <!--BookStrap swipper js Link-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>
    <!--Font Awesome Link-->
    <script src="https://kit.fontawesome.com/543bcc20b3.js" crossorigin="anonymous"></script>
      <!-- Lottie Link-->
    <script src="https://unpkg.com/@dotlottie/player-component@latest/dist/dotlottie-player.mjs" type="module"></script> 
</head>
<body>
     <!-- Header section with logo, title, and search bar -->
    <header class="header-main" id = "header-main-leader">
          <!-- Navigation container -->
        <nav class="header-main-navigation-container">
              <!-- Menu button -->
            <div class="header-main-menu-button">
            </div>
             <!-- Logo animation -->
            <dotlottie-player src="https://lottie.host/c8de3e83-6ad0-4247-93a0-cbdcd42610b1/IeCb6wJM4Z.json" background="transparent" speed="1" style="width: 150px; height: 150px;" loop autoplay></dotlottie-player>
             <!-- Main navigation links -->
            <div class="header-main-nav">
                  <!-- Title/logo -->
                <a href="index.html"><h1 class="header-main-title">Big Brain</h1></a>
                 <!-- Navigation menu -->
                <ul>
                    <!-- Redemption link with dynamic Vbucks count -->
                    <li>
                        <a href="redeem_page.html">Redeemption <img src="Photos/vbucks.png" alt="vbucks icon"><label class="header-main-vbucks"></label></a>
                    </li>
                </ul>
            </div>
        </nav>
         <!-- Icon to toggle mobile search -->
       
    </header>

     <!-- Main menu navigation -->
    <nav class="header-main-menu">
         <!-- Menu items -->
        <ul>
            <li>
                <!-- Redemption link with dynamic Vbucks count -->
                <a href="redeem_page.html">Redeemption <img src="Photos/vbucks.png" alt="vbucks icon"><label class="header-main-vbucks"></label></a>
            </li>
        </ul>
    </nav>
    <!-- Leaderboard header section -->
    <section class="leaderboard-header">
        <h1>LeaderBoard</h1>
    </section>
    <!-- Leaderboard container -->
    <article class="container" id="leaderboard-container">
        <div class="col" id="search-input-group">
            <input type="text" class="form-control rounded-4" id="search-input" 
            placeholder="Seach for data....">
            <i class="fa-solid fa-search"></i>
        </div>
        <!-- Leaderboard section -->
        <section id="leaderboard">
             <!-- Table for displaying leaderboard data -->
            <table>
                <thead>
                    <tr>    
                         <!-- Table headers with sorting icons -->
                        <th> Rank <i class="fa-solid fa-arrow-right fa-rotate-270"></i></th>
                        <th> Username <i class="fa-solid fa-arrow-right fa-rotate-270"></i></th>
                        <th> Quiz <i class="fa-solid fa-arrow-right fa-rotate-270"></i></th>
                        <th> Score <i class="fa-solid fa-arrow-right fa-rotate-270"></i></th>
                    </tr>
                </thead>
                <tbody>
                     <!-- Leaderboard data will be inserted dynamically here -->
                </tbody>
            </table>
        </section>
         <!-- Lottie animation player for visual appeal -->
        <div class="lottie-player">
            <dotlottie-player src="https://lottie.host/407d3e0c-0d46-422c-a563-db006edae977/fx0bGkmlJO.json" background="transparent" speed="1" style="width: 300px; height: 300px;" loop autoplay></dotlottie-player>
        </div>
        <!-- Exit buttons for leaderboard section -->
        <section class="leaderboard-exit-buttons">
            <a href="quiz_page.html" class="btn col-3">Play Again</a>
            <a href="index.html" class="btn col-3">Back to Home Page</a>
        </section>
    </article>

    <footer class="main-footer-container">
            <!--Site Map-->
            <ul class="ul-nostyle" id="main-footer-sitemap">
                <li>Category</li>
                <li><a href="index.html">English</a></li>
                <li><a href="index.html">Mathematics</a></li>
                <li><a href="index.html">Science</a></li>
            </ul>
            <!-- Site Map Ends Here -->

            <!--Social Media-->
            <ul class="ul-nostyle" id="main-footer-sm">
                <li>Follow Us</li>
                <li>
                    <a href="https://www.facebook.com/">
                        <i class="fa-brands fa-facebook-f" style="color: white;">
                        </i>
                    </a>
                    <a href="https://www.instagram.com/">
                        <i class="fa-brands fa-instagram" style="color: white;"></i>
                    </a>
                    <a href="https://twitter.com/">
                        <i class="fa-brands fa-twitter" style="color: white;"></i>
                    </a>
                </li>
            </ul>
            <!-- Social Media Ends Here -->

            <!-- Download App -->
            <div>
                <p class="main-footer-app">Download App</p>
                <i class="fa-solid fa-qrcode"></i>
            </div>
            <!-- Download App Ends Here -->

    </footer>
    
    <script>
        console.log('Stored Quiz Result:', sessionStorage.getItem('quizResult'));
        document.addEventListener("DOMContentLoaded", function () {
            
            //const url = "https://fedassignment-5bdb.restdb.io/rest/leaderboard";
            //const url2 = "https://fedassignment-85eb.restdb.io/rest/leaderboard";
            const url3 = "https://fedassignment-5bdb.restdb.io/rest/leaderboard";
            
            //const APIKEY = "65bde101c029b87c5966cdc6";
            //const APIKEY2 = "65bdfc153339b13e2a73c82b";
            const APIKEY3 = "65bde101c029b87c5966cdc6";
            
            // Get sessionstorage data
            const results = sessionStorage.getItem('quizResult');
            const resultsArray = JSON.parse(results);
            const username = resultsArray.username; 
            const score = resultsArray.score;  
            const quiz = resultsArray.quizTitle;

            console.log("Username:", username, 
            "\nScore:", score, 
            "\nQuiz:", quiz);

            toggleMobileMenu(); //Mobile View
            optainVbucks(); // Retrieve Vbucks

            loadTable().then(() => {
                console.log("Table loaded");

                // Remove the lottie player once table is loaded
                const lottiePlayerContainer = document.getElementsByClassName("lottie-player")[0];
                const child = lottiePlayerContainer.querySelector('dotlottie-player');
                lottiePlayerContainer.removeChild(child);
            });

            async function loadTable(){
                let settings = {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json",
                        "x-apikey": APIKEY3,
                        "Cache-Control": "no-cache"
                    }
                };
    
                // Fetch data for the table
                await fetch(url3, settings)
                .then(response => response.json())
                .then(response => {
    
    
                    // Rank Table based on score
                    var rankedData = rankTable(response); 

                    var searchBar = document.getElementById("search-input");
                    // Filter the table based on search input
                
                    searchBar.addEventListener("keyup", function (event) {
                        searchValue = searchBar.value.toLowerCase();
                        var filteredResponse = searchTable(searchValue,rankedData);
                        buildTable(filteredResponse);
                    });
                
                    // Build the table and display it on the page
                    buildTable(rankedData);
                
                    filter();
                    
                })
                .catch(error => {
                    console.error("Error fetching data:", error);
                });
            }
     
            //Rank Table
            function rankTable(response){
                var finalJasonData = [];
                var quizes=["Grammar","Vocabulary","Spelling Bee","Addition","Subtraction","Multiplication","Living Things","Plants","Magnets"]
                console.log("Before Ranking: ",response);

                // Rank the table based on quiz and score
                for (var i = 0; i <quizes.length; i++){
                    var rank = 1;
                    var quiz = quizes[i];
                    for (var score = 100; score >= 0; score--) {
                        
                        gotUser = false;
                        for (var j = 0; j < response.length; j++) {
                            if (response[j].score === score && response[j].quiz === quiz) {
    
                                jasonData = {
                                    "username": response[j].username,
                                    "score": response[j].score,
                                    "quiz": quiz,
                                    "rank": rank,   // Add rank to the data
                                };
                                finalJasonData.push(jasonData);
                                gotUser = true;
                            }
                        }
                        if (gotUser){
                            rank++;
                        }
                    }
                }
                // Print the ranked data
                console.log("After ranking: ",finalJasonData);
                return finalJasonData;
            }
            
            // Build the table and display it on the page
            function buildTable(response) {
                let content = "";
                for (var i = 0; i < response.length; i++) {
                    if (response[i].quiz === quiz) {
                        row = `<tr id='${response[i]._id}'>
                            <td scope="row">${response[i].rank}</td>
                            <td>${response[i].username}</td>
                            <td>${response[i].quiz}</td>
                            <td>${response[i].score}</td></tr>`;
                        content += row;
                    }
                }

                // Display the table on the page
                document.getElementById("leaderboard").getElementsByTagName("tbody")[0].innerHTML = content;
            }

            // Search the table
            function searchTable(searchValue,rankedData) {

                let filteredResponse = [];
                console.log("RankedData:", rankedData);
                rankedData.forEach((row, i) => {

                    // Convert all data to lowercase for case-insensitive search
                    let username = row.username.toLowerCase();
                    let rank = row.rank.toString();
                    let quiz = row.quiz.toLowerCase();
                    let score = row.score.toString();
                    
                    if (username.includes(searchValue) || rank.includes(searchValue) || quiz.includes(searchValue) || score.includes(searchValue)) {
                        filteredResponse.push(row);
                    }
                });
                return filteredResponse;
            }

            // Testing for searching table
            function filter(){
                const tableHeadings = document.querySelectorAll('thead th');
                const tableRows = document.querySelectorAll('tbody tr');
                tableHeadings.forEach((head, i) => {
                    let sortAsc = true;
                    head.onclick = () => {
                        tableHeadings.forEach(head => head.classList.remove('active'));
                        head.classList.add('active');

                        document.querySelectorAll('td').forEach(td => td.classList.remove('active'));

                        tableRows.forEach(row => {
                            row.querySelectorAll('td')[i].classList.add('active');
                        });

                        head.classList.toggle('asc', sortAsc);
                        sortAsc = head.classList.contains('asc') ? false : true;

                        sortTable(i, sortAsc);
                    }
                })

                    function sortTable(column, sortAsc) {
                        [...tableRows].sort((a, b) => {
                        let firstRow, secondRow;

                         // Check if the column is the "score" column
                        if (column === 3) {
                            // If it's the "score" column, parse the score as a number
                            firstRow = parseFloat(a.querySelectorAll('td')[column].textContent);
                            secondRow = parseFloat(b.querySelectorAll('td')[column].textContent);
                        } else {
                            // If it's not the "score" column, use text content as before
                            firstRow = a.querySelectorAll('td')[column].textContent.toLowerCase();
                            secondRow = b.querySelectorAll('td')[column].textContent.toLowerCase();
                        }

                        return sortAsc ? (firstRow > secondRow ? 1 : -1) : (firstRow > secondRow ? -1 : 1);
                    })
                    .map(sortedRow => document.querySelector('tbody').appendChild(sortedRow));
                }

            };

            // Retrieve Vbucks
            function optainVbucks() {

                let vbucksPlaceHolder = document.querySelectorAll(".header-main-vbucks")
                var username = sessionStorage.getItem("username");
                var userId = null

                let settings = {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json",
                        "x-apikey": APIKEY3,
                        "Cache-Control": "no-cache"
                    },
                }

                fetch(url3, settings)
                    .then(response => response.json())
                    .then(response => {
                        console.log(response);
                        response.forEach(res => {
                            if (res.username === username){
                                userId = res._id
                                // Print vbucks count in the header
                                vbucksPlaceHolder.forEach(vb => {
                                    vb.textContent = res.vbucks
                                })
                            }
                        });
                    })
                    .catch(error => {
                        console.log(error);
                    });
            }
            });

            function toggleMobileMenu(){
                /* Navation menu when device is switched to mobile or tablet */
                var menuButton = document.querySelector('.header-main-menu-button');
                var menu = document.querySelector('.header-main-menu');
        
                var ismenuOpen = false;
        
                menuButton.addEventListener("click", function() {
                    if (!ismenuOpen) {
                        menu.style.display = "block";
                        ismenuOpen = true;
                    } else {
                        menu.style.display="none";
                        ismenuOpen = false;
                    }
                },false);
            }
    </script>
</body>
</html>