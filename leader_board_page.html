<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href = "styling.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
</head>

<body>
    <header>
        <nav class = "navbar navbar-expand navbar-dark bg-dark">
            <div class = "container">
                <img src="clipart-brain-muscle-4.png" alt="image logo" style="max-height: 70px; width: auto;">
                <a href="#" class = "navbar-brand">Big Brain</a>
                
                
                <ul class = "navbar-nav">
                    <li class ="nav-item">
                        <a href="#" class="nav-link active">Home</a>
                    </li>
                    <li class ="nav-item">
                        <a href="#" class="nav-link">Store</a>
                    </li>
                </ul>
                
            </div>
        </nav>
    </header>

    <article>

    </article>

    <article class="container" id="leader-board">

        <section class="row">
            <div class="col">
                <input type="text" class="form-control" id="search-input">
            </div>
        </section>
        
        <section>
            <table class="table table-striped" id="leader-board">
                <thead>
                    <tr>
                        <th scope="col">Rank</th>
                        <th scope="col">Username</th>
                        <th scope="col">Quiz</th>
                        <th scope="col">Score</th>
                    </tr>
                </thead>
                <tbody>
                    
                </tbody>
            </table>
        </section>
    </article>
    
    <script>
        console.log('Stored Quiz Result:', sessionStorage.getItem('quizResult'));
        document.addEventListener("DOMContentLoaded", function () {
            const url = "https://fedassignment-85eb.restdb.io/rest/leaderboard";
            const APIKEY = "65bdfc153339b13e2a73c82b";

             const array = JSON.parse(data);
            const username = array.username;
            const score = array.score;
            const quiz = array.quizTitle;
            console.log("Username:", username);
            console.log("score:",score);
            console.log("quiz:",quiz);


            var searchBar = document.getElementById("search-input");

            let settings = {
                method: "GET",
                headers: {
                    "Content-Type": "application/json",
                    "x-apikey": APIKEY,
                    "Cache-Control": "no-cache"
                }
            };

            // Fetch data for the table
            fetch(url, settings)
                .then(response => response.json())
                .then(response => {
                    // Check if the username and quiz already exists in the database
                    
                    for (var i = 0; i < response.length; i++) {
                        if (response[i].username === username && response[i].quiz === quiz) {
                            
                            if (response[i].score < score) {
                                response[i].score = score;
                                userId = response[i]._id;
                                rank = 0;

                                var jsonData= {
                                    "username": username,
                                    "score": score,
                                    "quiz": quiz,
                                };
                                let Settings = {
                                    method: "PUT",
                                    headers: {
                                        "Content-Type": "application/json",
                                        "x-apikey": APIKEY,
                                        "Cache-Control": "no-cache"
                                    },
                                    body: JSON.stringify(jsonData)
                                };
                                return fetch(url + "/" + userId, Settings)
                                    .then(response => response.json())
                                    .then(response => {
                                        console.log("Updated data:", response);
                                    })
                                    .catch(error => {
                                        console.error("Error updating data:", error);
                                    });
                            }
                        }
                        else{
                            var jsonData = {
                                "username": username,
                                "score": score,
                                "quiz": quiz,
                            };
                            let settings = {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                    "x-apikey": APIKEY,
                                    "Cache-Control": "no-cache"
                                },
                                body: JSON.stringify(data)
                            };
                            return fetch(url, settings)
                                .then(response => response.json())
                                .then(response => {
                                    console.log("Added data:", response);
                                })
                                .catch(error => {
                                    console.error("Error adding data:", error);
                                });
                        }
                    }
                })
                .then(response => {


                    // Rank Table based on score
                    var rankedData = rankTable(response);  
                    
                    // Filter the table based on search input
                    searchBar.addEventListener("keyup", function (event) {
                        searchValue = searchBar.value.toLowerCase();
                        var filteredResponse = searchTable(searchValue, rankedData);
                        buildTable(filteredResponse);
                    });

                    // Build the table and display it on the page
                    buildTable(rankedData);
                })
                .catch(error => {
                    console.error("Error fetching data:", error);
                });

                        
            // Testing to modify json data for ranking table
            function rankTable(response){
                var finalJasonData = [];
                rank = 1;
                for (var score = 100; score >= 0; score--) {
                    
                    gotUser = false;
                    for (var i = 0; i < response.length; i++) {
                        if (response[i].score === score) {

                            jasonData = {
                                "username": response[i].username,
                                "score": response[i].score,
                                "quiz": response[i].quiz,
                                "rank": rank,   // Add rank to the data
                            };
                            finalJasonData.push(jasonData);
                            gotUser = true;
                        }
                    }
                    if (gotUser){
                        rank++;
                    }
                }
                console.log(finalJasonData);
                return finalJasonData;
            }
            // Testing ends here
            
            // Search the table
            function searchTable(searchValue, response) {
                let filteredResponse = [];
                for (var i = 0; i < response.length; i++) {
                    if (response[i].username.toLowerCase().includes(searchValue)) {
                        filteredResponse.push(response[i]);
                    }
                }
                return filteredResponse;
            }

            // Build the table and display it on the page
            function buildTable(response) {
                let content = "";
                for (var i = 0; i < response.length; i++) {
                    content = `${content}<tr id='${response[i]._id}'>
                        <th scope="row">${response[i].rank}</th>
                        <td>${response[i].username}</td>
                        <td>${response[i].quiz}</td>
                        <td>${response[i].score}</td></tr>`;
                }

                // Display the table on the page
                document.getElementById("leader-board").getElementsByTagName("tbody")[0].innerHTML = content;
            }
        });


    //[STEP 8]: Make our AJAX calls
    // Once we get the response, we modify our table content by creating the content internally. We run a loop to continuously add on data
    // RESTDb/NoSql always adds in a unique id for each data; we tap on it to have our data and place it into our links 


    </script>
</body>
</html>