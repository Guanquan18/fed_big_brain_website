<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Big Brain</title>
    <!-- External CSS -->
    <link rel="stylesheet" href = "styling.css">
      <!--BookStrap Link-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat&family=Oswald:wght@200;300&family=Playpen+Sans:wght@500&family=Poppins&family=Ubuntu:wght@500&display=swap" rel="stylesheet">
      <!-- Lottie Link-->
    <script src="https://unpkg.com/@dotlottie/player-component@latest/dist/dotlottie-player.mjs" type="module"></script> 
    <!-- Link to Font Awesome for icons -->
    <script src="https://kit.fontawesome.com/543bcc20b3.js" crossorigin="anonymous"></script>
</head>
<body>
      <!-- Header section with logo, title, and search bar -->
      <header class="header-main">
          <!-- Navigation container -->
        <nav class="header-main-navigation-container">
             <!-- Menu button -->
            <div class="header-main-menu-button">
            </div>
            <!-- Logo animation -->
            <dotlottie-player src="https://lottie.host/c8de3e83-6ad0-4247-93a0-cbdcd42610b1/IeCb6wJM4Z.json" background="transparent" speed="1" style="width: 150px; height: 150px;" loop autoplay></dotlottie-player>
             <!-- Main navigation links -->
            <div class="header-main-nav">
                 <!-- Title/logo -->
                <a href="index.html"><h1 class="header-main-title">Big Brain</h1></a>
                   <!-- Navigation menu -->
                <ul>
                    <!-- Redemption link with dynamic Vbucks count -->
                    <li>
                        <a href="redeem_page.html">Redeemption (<label class="header-main-vbucks"></label> Vbucks)</a>
                    </li>
                </ul>
            </div>
        </nav>
          <!-- Icon to toggle mobile search -->
        <div class="search_icon" onclick="toggleMobileSearch()">
        </div>
         <!-- Main header search bar -->
        <div class="main-header-search">
              <!-- Search input field -->
            <input type="text" id="mySearch" oninput="myFunction()" placeholder="Search">
             <!-- Search result menu -->
            <ul id="myMenu">
                 <!-- Various quiz categories -->
                <li><a href="#math_quiz_category">Math</a></li>
                <li><a href="#science_quiz_category">Science</a></li>
                <li><a href="#english_quiz_category">English</a></li>
                <li><a href="#">Geography</a></li>
                <li><a href="#">History</a></li>
                <li><a href="#">Chinese</a></li>
                <li><a href="#">Malay</a></li>
                <li><a href="#">Tamil</a></li>
            </ul>
        </div>
    </header>
     <!-- Main menu navigation -->
    <nav class="header-main-menu">
        <ul>
            <li>
                 <!-- Redemption link with dynamic Vbucks count -->
                <a href="redeem_page.html">Redeemption (<label class="header-main-vbucks"></label> Vbucks)</a>
            </li>
            <li>
                   <!-- Log out link -->
                <a href="login_page.html">Log Out</a>
            </li>
        </ul>
    </nav>
    
    <!-- Redemption -->
    <section class="Redemption-page-section" id = "redemption-section">
        <div class="container">
            <!-- Header for redemption category -->
            <div class= "header_quiz_category">
                <h1 class="text-centre mb-4 category_title">Redemption</h1>
            </div>     
            <!-- Redemption items -->    
            <div class="row">
                <!-- Each card represents a redemption item -->
                <div class="col-md-3">
                    <div class="card" id="phone-case-card">
                        <img src="Photos/phone_case.jpg" class="card-img-top" alt="Phone Case">
                        <div class="card-body">
                            <h5 class="card-text">Big Brain Phone Case</h5>
                        </div>
                        <div class="card-footer">
                             <!-- VBucks info -->
                            <div class="vbucks-info">
                                <img src="Photos/vbucks.png" alt="VBucks Image">
                                <span class="vbucks-number">1000 vbucks</span>
                            </div>
                            <!-- Redeem button -->
                            <button class="btn btn-hover open-redemption-pop-up " data-popup-target="#pop_up"  data-required-vbucks ="1000">Redeem</button>
                        </div>
                    </div>
                </div>
                <!-- Each card represents a redemption item -->
                <div class="col-md-3">
                    <div class="card" id="laptop-sleeve-card">
                        <img src="Photos/laptop_sleeve.jpg" class="card-img-top" alt="Lapptop sleeve Image">
                        <div class="card-body">
                            <h5 class="card-text">Smarty Laptop sleeve </h5>
                        </div>
                        <div class="card-footer">
                             <!-- VBucks info -->
                            <div class="vbucks-info">
                                <img src="Photos/vbucks.png" alt="VBucks Image">
                                <span class="vbucks-number">500 vbucks</span>
                            </div>
                            <!-- Redeem button -->
                            <button class="btn btn-hover open-redemption-pop-up" data-popup-target="#pop_up"  data-required-vbucks="500">Redeem</button>
                        </div>
                    </div>
                </div>
                <!-- Each card represents a redemption item -->
                <div class="col-md-3">
                    <div class="card" id="keychain-card">
                        <img src="Photos/keychain.jpg" class="card-img-top" alt="Keychain Image">
                        <div class="card-body">
                            <h5 class="card-text">Brainy Keychain</h5>
                        </div>
                        <div class="card-footer">
                             <!-- VBucks info -->
                            <div class="vbucks-info">
                                <img src="Photos/vbucks.png" alt="VBucks Image">
                                <span class="vbucks-number">300 vbucks</span>
                            </div>
                            <!-- Redeem button -->
                            <button class="btn btn-hover open-redemption-pop-up" data-popup-target="#pop_up"  data-required-vbucks="300">Redeem</button>
                        </div>
                    </div>
                </div>
                <!-- Each card represents a redemption item -->
                <div class="col-md-3">
                    <div class="card" id="mug-card">
                        <img src="Photos/mug.jpg" class="card-img-top" alt="Mug Image">
                        <div class="card-body">
                            <h5 class="card-text">Big Mug</h5>
                        </div>
                        <div class="card-footer">
                             <!-- VBucks info -->
                            <div class="vbucks-info">
                                <img src="Photos/vbucks.png" alt="VBucks Image">
                                <span class="vbucks-number">600 vbucks</span>
                            </div>
                            <!-- Redeem button -->
                            <button class="btn btn-hover open-redemption-pop-up" data-popup-target="#pop_up"  data-required-vbucks="600">Redeem</button>
                        </div>
                    </div>
                </div>
                <!-- Each card represents a redemption item -->
                <div class="col-md-3">
                    <div class="card" id="pencilcase-card">
                        <img src="Photos/pencilcase.jpg" class="card-img-top" alt="pencilcase Image">
                        <div class="card-body">
                            <h5 class="card-text">Brainy Pencil</h5>
                        </div>
                        <div class="card-footer">
                             <!-- VBucks info -->
                            <div class="vbucks-info">
                                <img src="Photos/vbucks.png" alt="VBucks Image">
                                <span class="vbucks-number">200 vbucks</span>
                            </div>
                            <!-- Redeem button -->
                            <button class="btn btn-hover open-redemption-pop-up" data-popup-target="#pop_up"  data-required-vbucks="200">Redeem</button>
                        </div>
                    </div>
                </div>
                <!-- Each card represents a redemption item -->
                <div class="col-md-3">
                    <div class="card" id="notebook-card">
                        <img src="Photos/notebook.jpg" class="card-img-top" alt="notebook Image">
                        <div class="card-body">
                            <h5 class="card-text"> Exclusive Big Brain notebook</h5>
                        </div>
                        <div class="card-footer">
                             <!-- VBucks info -->
                            <div class="vbucks-info">
                                <img src="Photos/vbucks.png" alt="VBucks Image">
                                <span class="vbucks-number">300 vbucks</span>
                            </div>
                            <!-- Redeem button -->
                            <button class="btn btn-hover open-redemption-pop-up" data-popup-target="#pop_up"  data-required-vbucks="300">Redeem</button>
                        </div>
                    </div>
                </div>
                <!-- Each card represents a redemption item -->
                <div class="col-md-3">
                    <div class="card" id="waterbottle-card">
                        <img src="Photos/waterbottle.jpg" class="card-img-top" alt="Waterbottle Image">
                        <div class="card-body">
                            <h5 class="card-text"> Water Bottle </h5>
                        </div>
                        <div class="card-footer">
                             <!-- VBucks info -->
                            <div class="vbucks-info">
                                <img src="Photos/vbucks.png" alt="VBucks Image">
                                <span class="vbucks-number">600 vbucks</span>
                            </div>
                            <!-- Redeem button -->
                            <button class="btn btn-hover open-redemption-pop-up" data-popup-target="#pop_up"  data-required-vbucks="600">Redeem</button>
                        </div>
                    </div>
                </div>
                <!-- Each card represents a redemption item -->
                <div class="col-md-3">
                    <div class="card" id="bag-card">
                        <img src="Photos/bag.jpg" class="card-img-top" alt="Bag Image">
                        <div class="card-body">
                            <h5 class="card-text">Big Brain Bag</h5>
                        </div>
                        <div class="card-footer">
                             <!-- VBucks info -->
                            <div class="vbucks-info">
                                <img src="Photos/vbucks.png" alt="VBucks Image">
                                <span class="vbucks-number">400 vbucks</span>
                            </div>
                            <!-- Redeem button -->
                            <button class="btn btn-hover open-redemption-pop-up" data-popup-target="#pop_up"  data-required-vbucks="400">Redeem</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
     <!-- Redemption pop-up -->
    <div class="pop-up" id="redemption-pop-up">
        <div class="pop-up-content">
            <!-- Close button for the pop-up -->
            <span class="close-button" id="close-redemption-pop-up">&times;</span>
             <!-- Redemption status image -->
            <div id = "redemption-status-img"></div>
            <!-- Redemption status message -->
            <div id="redemption-status-message">
            </div>
        </div>
    </div>
    <!-- Redemption overlay -->
    <div id = "redemption-overlay"></div>
     
    <footer class="main-footer-container">
        <!--Site Map-->
        <ul class="ul-nostyle" id="main-footer-sitemap">
            <li>Category</li>
            <li><a href="index.html">English</a></li>
            <li><a href="index.html">Mathematics</a></li>
            <li><a href="index.html">Science</a></li>
        </ul>
        <!-- Site Map Ends Here -->

        <!--Social Media-->
        <ul class="ul-nostyle" id="main-footer-sm">
            <li>Follow Us</li>
            <li>
                <a href="https://www.facebook.com/">
                    <i class="fa-brands fa-facebook-f" style="color: white;">
                    </i>
                </a>
                <a href="https://www.instagram.com/">
                    <i class="fa-brands fa-instagram" style="color: white;"></i>
                </a>
                <a href="https://twitter.com/">
                    <i class="fa-brands fa-twitter" style="color: white;"></i>
                </a>
            </li>
        </ul>
        <!-- Social Media Ends Here -->

        <!-- Download App -->
        <div>
            <p class="main-footer-app">Download App</p>
            <i class="fa-solid fa-qrcode"></i>
        </div>
        <!-- Download App Ends Here -->

    </footer>
    <script>

        const url2 = "https://fedassignment-85eb.restdb.io/rest/account";
        const url3 = "https://fedassignment-2f26.restdb.io/rest/account";
        const APIKEY2 = "65bdfc153339b13e2a73c82b";
        const APIKEY3 = "65c3bf2570dd296a0c2630f3";

        const username = sessionStorage.getItem('username');
        const password = sessionStorage.getItem('password');
        var userID = null;

        // Get elements
        const redemptionPopUp = document.getElementById('redemption-pop-up');
        const closeButton = document.getElementById('close-redemption-pop-up');
        const overlay = document.getElementById('redemption-overlay');

        const redemptionStatusImg = document.getElementById('redemption-status-img');
        const redemptionStatusMessage = document.getElementById('redemption-status-message');
        const successful_animation=  '<dotlottie-player src="https://lottie.host/cecc38c1-fa56-4f0c-927c-20e73c9a53a1/iFFBJkBl4V.json" background="transparent" speed="1" style="width: 300px; height: 300px;" loop = "5" autoplay></dotlottie-player>'
        const unsuccessful_animation = ' <dotlottie-player src="https://lottie.host/b243beda-f13b-485b-9dff-6eec81b021e1/5nooAZyoNF.json" background="transparent" speed="1" style="width: 300px; height: 300px;" loop autoplay></dotlottie-player>'

        // Function to open the pop-up
        function openRedemptionPopUp(requiredVbucks) {
            // Call fetchData() and await its result to get the current vbucks
            optainVbucks().then(currentVbucks => {
                redemptionPopUp.classList.add('active');
                overlay.classList.add('active');
        
                if (currentVbucks >= requiredVbucks) {
                    // Display success image and message
                    redemptionStatusImg.innerHTML = successful_animation;
                    redemptionStatusMessage.textContent = 'Redeemed successfully!';
                    deductVbucks(userID, currentVbucks, requiredVbucks);
                } else {
                    // Display error image and message
                    redemptionStatusImg.innerHTML = unsuccessful_animation;
                    redemptionStatusMessage.textContent = 'Insufficient vbucks!';
                }
            }).catch(error => {
                console.error('Error fetching vbucks:', error);
            });
        }

        async function deductVbucks(userID, currentVbucks, requiredVbucks) {
            var newVbucks = currentVbucks - requiredVbucks;
            const json = {
                "username": username,
                "password": password,
                "vbucks": newVbucks
            };
            try{
                settings = {
                    "method": "PUT",
                    "headers": {
                    "content-type": "application/json",
                    "x-apikey": APIKEY3
                    },
                    body: JSON.stringify(json)
                }
                fetch(`${url3}/${userID}`, settings)
                .then(res => res.json())
                .then(data => console.log(data))

                var result = await response.json();
                console.log("Deducted Successfull: ",result);

            }catch(error){
                console.log(error);
                return -1; // Return a default value in case of an error
            }
        }

        async function optainVbucks() {
            try {

                settings = {
                    "method": "GET",
                    "headers": {
                    "content-type": "application/json",
                    "x-apikey": APIKEY3
                    }
                }

                return fetch(url3, settings)
                .then(res => res.json())
                .then(data => {
                    for (var i = 0; i < data.length; i++) {
                        if (data[i].username === username) {
                            userID = data[i]._id;
                            return data[i].vbucks;
                        }
                    }
                    if (userID === null) {
                        console.log("User not found");
                        return -1; // Return a default value in case of an error
                    }
                })
                .catch(error => {
                    console.log(error);
                    return -1; // Return a default value in case of an error
                })
            } catch (error) {
                console.log(error);
                return -1; // Return a default value in case of an error
            }
        }

        async function fetchData() {
            try {
                const currentVbucks = await optainVbucks();
                return currentVbucks;
            } catch (error) {
                console.error('Error fetching vbucks:', error);
                return -1; // Return a default value in case of an error
            }
        }


        // Event listener for opening the pop-up
        document.querySelectorAll('.open-redemption-pop-up').forEach(button => {
            button.addEventListener('click', function() {
                const requiredVbucks = parseInt(button.dataset.requiredVbucks); // Get the required vbucks from the data attribute
                openRedemptionPopUp(requiredVbucks);
            });
        });

        // Event listener for closing the pop-up when clicking on the close button
        closeButton.addEventListener('click', function() {
            redemptionPopUp.classList.remove('active');
            overlay.classList.remove('active');
        });

        // Event listener for closing the pop-up when clicking on the overlay
        overlay.addEventListener('click', function() {
            redemptionPopUp.classList.remove('active');
            overlay.classList.remove('active');
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
</body>
</html>